!function(t){"use strict";t.Point=t.Class.extend({_x:null,_y:null,init:function(t,e){this._x=t,this._y=e},x:function(t){return t&&(this._x=t),this._x},y:function(t){return t&&(this._y=t),this._y}})}(HeO2_legacy),function(t){"use strict";t.Rectangle=t.Class.extend({_left:null,_top:null,_right:null,_bottom:null,init:function(t,e,i,n,s){s=s||!1,this._left=t,this._top=e,this._right=s?t+i:i,this._bottom=s?e+n:n},toPointAndSize:function(){return{point:new t.Point(this._left,this._top),size:{width:this.width,height:this.height}}},toPoints:function(){return{topLeft:new t.Point(this._left,this._top),bottomRight:new t.Point(this._right,this._bottom)}},left:function(t){return t?(this._left=t,this):this._left},top:function(t){return t?(this._top=t,this):this._top},right:function(t){return t?(this._right=t,this):this._right},bottom:function(t){return t?(this._bottom=t,this):this._bottom},height:function(t){return t?(this._bottom=this._top+t,this):Math.abs(this._bottom-this._top)},width:function(t){return t?(this._right=this._left+t,this):Math.abs(this._right-this._left)}})}(HeO2_legacy),function(t,e){"use strict";var i=[],n=Object.create(null);t.Grid=t.EventingClass.extend({_DEFAULTS:{debug:!0},_builders:null,_document:null,_options:null,_views:null,init:function(t){this._super(),this._builders=Object.create(null),this._views=Object.create(null),this._createHostInterface(),this._attach(),this.setOptions(t),this._loadExtenders()},addView:function(t,e,i){if(void 0===this._views[t]&&this._emitAddingView(t,e,i)){var n=this._createView(e,i);n&&(this._views[t]=n,this._emitAddedView(this._views[t]))}else this._log("warn","HeO2_legacy::Grid | A view with id '"+t+"' was already created");return this},create:function(){return this._emitCreating()&&(this._create(),this._emitCreated(),this._emitDocumentReady()),this},getDocument:function(){return this._document},open:function(t,e){return e=e||null,t instanceof File&&this._emitOpeningFile(t)?this._openFile(t):this._emitOpeningRaw(t,e)&&this._spawn(this._openRaw.bind(this,t,e)),this},setOptions:function(t){return this._options=e.extend({},this._options||this._DEFAULTS,t),this},_document_documentReady:function(t){this._emitOpened()},_filereader_load:function(t,e,i){this._openRaw(i.target.result,e)},_filereader_error:function(t){this._log("error","The was an error reading a file object. Error: "+t.target.error.name)},_attach:function(){this.on("document-ready",this._document_documentReady.bind(this))},_create:function(){this._document=new t.Grid.Document(this),this._emitDocumentCreated()},_openFile:function(t){var e=new FileReader;e.addEventListener("error",this._filereader_error.bind(this)),t.type.indexOf("text/")!==-1?(e.addEventListener("load",this._filereader_load.bind(this,"text",t.type)),e.readAsText(t)):(e.addEventListener("load",this._filereader_load.bind(this,"binary-array",t.type)),e.readAsArrayBuffer(t))},_openRaw:function(t,e){return this._create(),["ok","async"].indexOf(this._requestDocumentBuilder(t,e))!==-1},_loadExtenders:function(){for(var t=0,e=i.length;t<e;++t)new i[t](this._hostInterface)},_log:function(t,e){this._options.debug&&["log","warn","error"].indexOf(t)!==-1&&console[t](e)},_requestDocumentBuilder:function(t,e){var i={data:t,mime:e,document:this._document,status:null},n=this._createDocumentBuilder(e);if(n){var s=n(i);if(n)switch(i.status){case"ok":this._emitDocumentReady();break;case"failed":this._log("warn","HeO2_legacy::Grid | An extender was unable to process the input data with mime type '"+e+"'"),this._emitOpenFailed();break;case"async":this._emitOpeningAsync();break;default:this._emitExtenderFailure("request-document-build-invalid-code"),this._log("error","HeO2_legacy::Grid | Extender reported invalid status '"+s+"'")}}return i.status},_spawn:function(t){setTimeout(t,0)},_hostInterface:null,_createHostInterface:function(){this._hostInterface={getDocument:function(){return this._document}.bind(this),ref:this,registerDocumentBuilder:function(t,e){this._builders[t]=e}.bind(this)}},_createDocumentBuilder:function(t){return this._builders[t]?this._builders[t]:(this._emitExtenderFailure("request-document-build-unsupported"),this._log("warn","HeO2_legacy::Grid | No extenders are loaded to read '"+t+"'"),null)},_createView:function(t,e){return n[t]?new n[t](this._hostInterface,e):(this._log("warn","HeO2_legacy::Grid | Requested view '"+t+"' does not exist"),null)},_emitAddedView:function(t){var e={viewInstance:t};this.emit("added-view",e)},_emitAddingView:function(t,e,i){var n={cancel:null,id:t,viewType:e,options:i};return this.emit("adding-view",n),!n.cancel},_emitCreated:function(){var t={document:this._document};this.emit("created",t)},_emitCreating:function(){var t={cancel:null};return this.emit("creating",t),t.cancel&&this._log("log","HeO2_legacy::Grid | Create cancelled by listener"),!t.cancel},_emitDocumentReady:function(){var t=Object.create(null);this.emit("document-ready",t)},_emitDocumentCreated:function(){var t=Object.create(null);this.emit("document-object-created",t)},_emitExtenderFailure:function(t){var e={action:t};this.emit("extender-failure",e)},_emitOpened:function(){var t={document:document};this.emit("opened",t)},_emitOpeningAsync:function(){var t=Object.create(null);this.emit("opening-async",t)},_emitOpenFailed:function(){var t=Object.create(null);this.emit("open-failed",t)},_emitOpeningFile:function(t){var e={cancel:null,file:t};return this.emit("opening-file",e),e.cancel&&this._log("log","HeO2_legacy::Grid | Opening file cancelled by listener"),!e.cancel},_emitOpeningRaw:function(t,e){var i={cancel:null,data:t,format:e};return this.emit("opening-raw",i),i.cancel&&this._log("log","HeO2_legacy::Grid | Opening raw cancelled by listener"),!i.cancel}}),t.Grid.registerExtender=Array.prototype.push.bind(i),t.Grid.registerView=function(t,e){void 0===n[t]?n[t]=e:console.warn("HeO2_legacy::Grid | A view type with name '"+t+"' has already been registered")},t.Grid.create=function(e){return new t.Grid(e)},t.__unittest__&&(t.Grid._views=n)}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.Document=t.EventingClass.extend({_COPY_ASYNC_TIMEOUT:100,_owner:null,_data:null,_ready:!1,_sizeRectangle:null,init:function(e){this._super(),this._data=[],this._sizeRectangle=new t.Rectangle(0,0,0,0),this._owner=e,this._owner.on("document-ready",this._owner_documentReady.bind(this))},changeCell:function(i,n,s,r){return s=parseInt(s),r=parseInt(r),this._checkRow(s),this._data[s][r].value=i&&i.toString?i.toString():"",this._data[s][r].meta=e.extend({},this._data[s][r].meta,n),this._emitUpdate(new t.Rectangle(r,s,r,s)),this},change:function(t,e,i,n){return e=e||0,i=i||0,this._set(t,e,i,n),this},changeRow:function(t,e,i,n){return i=i||0,this._set([t],e,i,n),this},deleteRow:function(t){this._emitDeletingRow(t)&&(this._data.splice(t,1),this._sizeRectangle.bottom(this._sizeRectangle.bottom()-1),this._emitDeletedRow(t))},getSize:function(){return this._sizeRectangle},getCell:function(t,e){if(void 0!==this._data[t])return this._data[t][e]},getRaw:function(){return this._data},isEmpty:function(){return 0===this._data.length},isReady:function(){return this._ready},_owner_documentReady:function(){this._ready=!0},_checkRow:function(t){t=parseInt(t),void 0===this._data[t]&&(this._data[t]=[])},_set:function(e,i,n,s){if(this._emitUpdating(e,i,n)){i=parseInt(i),n=parseInt(n),s=s||{};var r={options:s,canAsync:s.forceSync||!1,data:e,xDest:n,yDest:i,xSource:0,xSourceLength:null,ySource:0,ySourceLength:e.length,updateRect:new t.Rectangle(n,i,0,0)};s.forceAsync?(s.async=!0,setTimeout(this._setAsync.bind(this,r),0)):this._setAsync(r)}},_setAsync:function(t){for(var e=Date.now()+this._COPY_ASYNC_TIMEOUT;t.ySource<t.ySourceLength;++t.ySource,++t.yDest){for(this._checkRow(t.yDest),t.xSourceLength=t.data[t.ySource].length;t.xSource<t.xSourceLength;++t.xSource,++t.xDest)if(this._setCell(t.yDest,t.xDest,t.data[t.ySource][t.xSource]),t.canAsync&&Date.now()>e)return t.options.async=!0,void setTimeout(this._setAsync.bind(this,t),0);t.xDest=0,t.xSource=0,this._sizeRectangle.right(Math.max(this._sizeRectangle.right(),this._data[t.yDest].length)),t.updateRect.right(Math.max(t.updateRect.right(),t.xSourceLength))}this._sizeRectangle.bottom(this._data.length),t.updateRect.right(t.updateRect.left()+t.updateRect.right()),t.updateRect.bottom(t.updateRect.top()+t.data.length),this._emitUpdate(t.updateRect),t.options.async&&this._emitAsyncCopyComplete()},_setCell:function(t,e,i){"object"!=typeof i&&(i={value:i}),void 0===i.value&&(i.value=""),void 0===i.meta&&(i.meta=Object.create(null)),this._data[t][e]=i},_emitAsyncCopyComplete:function(){var t=Object.create(null);this.emit("async-copy-complete",t)},_emitDeletingRow:function(t){var e={cancel:null,row:t};return this.emit("row-deleting",e),!e.cancel},_emitDeletedRow:function(t){var e={row:t};this.emit("row-deleted",e)},_emitUpdate:function(t){var e={updateRect:t};this.emit("updated",e)},_emitUpdating:function(t,e,i){var n={data:t,column:i,row:e,cancel:null};return this.emit("updating",n),!n.cancel}})}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.Extender=t.Class.extend({_options:null,_host:null,init:function(t,e){this._host=t,this.setOptions(e)},setOptions:function(t){this._options=e.extend({},this._options||{},t)}})}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.View=t.Grid.Extender.extend({init:function(t,e){this._super(t,e)}})}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.View.Table=t.Grid.View.extend({_TABLE_DEFAULTS:{target:null},_RENDER_ASYNC_TIMEOUT:5e5,_$target:null,_cellIndex:null,init:function(t,i){this._super(t,e.extend({},this._TABLE_DEFAULTS,i)),this._cellIndex=[],this._attach(),t.getDocument()&&!t.getDocument().isEmpty()&&this._fullRender()},_afterCell:function(t){},_afterRow:function(t){},_beforeCell:function(t){},_beforeRow:function(t){},_document_updated:function(t){this._host.getDocument().isReady()&&this._renderUpdates(t.updateRect)},_document_rowDeleted:function(t){this._$target.find("tr:nth-child("+(t.row+1)+")").remove()},_host_documentReady:function(){this._fullRender()},_host_documentCreated:function(){this._host.getDocument().on("updated",this._document_updated.bind(this)),this._host.getDocument().on("row-deleted",this._document_rowDeleted.bind(this))},_attach:function(){var t=this._host.getDocument();t?this._host_documentCreated():this._host.ref.on("document-object-created",this._host_documentCreated.bind(this),!0),this._host.ref.on("document-ready",this._host_documentReady.bind(this)),this._$target=e(this._options.target)},_fullRender:function(){var t=this._host.getDocument().getRaw();this._renderRows({rawData:t,rowLength:t.length,row:0,rows:[]})},_renderCell:function(t,i,n){var s=null;return this._beforeCell({row:t,column:i,cellData:n}),s=e("<td></td>").text(n.value),void 0===this._cellIndex[t]&&(this._cellIndex[t]=[]),this._cellIndex[t][i]={element:s},this._afterCell({row:t,column:i,cellData:n,$td:s}),s},_renderRows:function(t){for(var i=Date.now()+this._RENDER_ASYNC_TIMEOUT;t.row<t.rowLength;++t.row){var n=e("<tr></tr>");this._beforeRow({row:t.row,rowData:t.rawData[t.row],$tr:n});for(var s=0,r=t.rawData[t.row].length;s<r;++s)n.append(this._renderCell(t.row,s,t.rawData[t.row][s]));if(this._afterRow({row:t.row,rowData:t.rawData[t.row],$tr:n}),t.rows.push(n[0]),Date.now()>i)return void setTimeout(this._renderRows.bind(this,t),0)}this._$target.empty().append(e("<table></table>").append(t.rows))},_renderUpdates:function(t){for(var e=t.top();e<=t.bottom();++e)for(var i=t.left();i<=t.right();++i){if(!this._cellIndex[e]||!this._cellIndex[e][i])return void this._fullRender();this._cellIndex[e][i].element.text(this._host.getDocument().getCell(e,i).value)}}})}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerView("static",t.Grid.View.Table.extend({_STATIC_DEFAULTS:{},init:function(t,i){this._super(t,e.extend({},this._STATIC_DEFAULTS,i))},_attach:function(){this._super()}}))}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerView("custom-static",t.Grid.View.Table.extend({_STATIC_DEFAULTS:{callbacks:{beforeRow:null,afterRow:null,beforeCell:null,afterCell:null}},init:function(t,i){this._super(t,e.extend({},this._STATIC_DEFAULTS,i))},_afterCell:function(t){this._options.callbacks.afterCell&&this._options.callbacks.afterCell(t)},_afterRow:function(t){this._options.callbacks.afterRow&&this._options.callbacks.afterRow(t)},_beforeCell:function(t){this._options.callbacks.beforeCell&&this._options.callbacks.beforeCell(t)},_beforeRow:function(t){this._options.callbacks.beforeRow&&this._options.callbacks.beforeRow(t)},_attach:function(){this._super()}}))}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerView("edit",t.Grid.View.Table.extend({_DEFAULTS:{},_edit:null,init:function(t,i){this._super(t,e.extend({},this._DEFAULTS,i)),this._edit=Object.create(null)},_cell_click:function(t){var i=e(t.target),n=i.offset(),s=i.width(),r=i.height();this._destroyEdit(),this._edit.$td=i,this._edit.old=i.text(),this._edit.pos=i.data("pos"),this._edit.$input=e("<input />").attr("type","text").css({border:"none",position:"absolute",left:n.left+1,top:n.top,width:s,height:r}).css(this._extractFontSettings(i)).val(this._edit.old).blur(this._edit_blur.bind(this)).keypress(this._edit_keypress.bind(this)),e(document.body).append(this._edit.$input),this._edit.$input.focus()},_edit_blur:function(t){this._doEdit()},_edit_keypress:function(t){13===t.charCode&&this._doEdit()},_attach:function(){this._super()},_destroyEdit:function(){this._edit.$input&&this._edit.$input.remove()},_doEdit:function(){this._emitEditing()&&(this._host.getDocument().changeCell(this._edit.$input.val(),null,this._edit.pos.row,this._edit.pos.column),this._emitEdited()),this._destroyEdit()},_extractFontSettings:function(t){t instanceof e||(t=e(t));var i=t.css("background-color");return{fontFamily:t.css("font-family"),fontSize:t.css("font-size"),color:t.css("color"),backgroundColor:["rgba(0, 0, 0, 0)","transparent"].indexOf(i)!==-1?"#fff":i}},_renderCell:function(t,e,i){return this._super(t,e,i).data("pos",{row:t,column:e}).click(this._cell_click.bind(this))},_emitEdited:function(){var t={newValue:this._edit.$input.val(),oldValue:this._edit.old,pos:this._edit.pos};this._host.ref.emit("cell-edited",t)},_emitEditing:function(){var t={cancel:null,newValue:this._edit.$input.text(),oldValue:this._edit.old,pos:this._edit.pos};return this._host.ref.emit("cell-editing",t),!t.cancel}}))}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerExtender(t.Grid.Extender.extend({_MIME:"text/csv",_DEFAULTS:{characters:{separator:",",stringDelimiter:'"',escape:"\\",rowSeparator:"\n"},characterBatch:500},init:function(t){this._super(t,this._DEFAULTS),this._registerBuilder()},_document_asyncCopyComplete:function(){this._host.ref.emit("document-ready")},_host_requestBuild:function(t){if("text/csv"===t.mime){var e={data:[],rowIndex:null,action:"new-row",currentChar:null,cell:"",csv:t.data,document:t.document};t.document.on("async-copy-complete",this._document_asyncCopyComplete.bind(this)),this._parseCsv(e)?t.status="async":t.status="failed"}},_registerBuilder:function(){this._host.registerDocumentBuilder("text/csv",this._host_requestBuild.bind(this))},_parseCsv:function(t){do if(t.currentChar=t.csv.substr(0,1),t.csv=t.csv.substr(1),"new-row"===t.action&&(t.data.push([]),t.rowIndex=t.data.length-1,t.action="parse-cell"),"parse-quote"!==t.action||t.currentChar!==this._options.characters.stringDelimiter){if("parse-cell"===t.action){if(t.currentChar===this._options.characters.stringDelimiter){t.action="parse-quote";continue}if(t.currentChar===this._options.characters.separator||t.currentChar===this._options.characters.rowSeparator){t.data[t.rowIndex].push({value:t.cell,meta:{}}),t.cell="",t.currentChar===this._options.characters.rowSeparator&&(t.action="new-row");continue}}if("parse-cell"===t.action||"parse-quote"===t.action||"parse-escape"===t.action){if(t.currentChar===this._options.characters.escape){t.action="parse-escape";continue}t.cell+=t.currentChar,t.csv.length||t.data[t.rowIndex].push({value:t.cell,meta:{}})}}else t.action="parse-cell";while(t.csv.length&&t.csv.length%this._options.characterBatch);return t.csv.length?setTimeout(this._parseCsv.bind(this,t),0):t.document.change(t.data,0,0,{forceAsync:!0}),!0}}))}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerExtender(t.Grid.Extender.extend({init:function(t){this._super(t),this._registerBuilder()},_host_requestBuild:function(t){t.status=this._buildFromJson(JSON.parse(t.data))?"ok":"failed"},_buildFromJson:function(t){for(var e=[],i=0,n=t.length;i<n;++i){e[i]=[];for(var s=0,r=t[i].length;s<r;++s)e[i][s]=t[i][s]}return this._host.getDocument().change(e),!0},_registerBuilder:function(){this._host.registerDocumentBuilder("application/json",this._host_requestBuild.bind(this))}}))}(HeO2_legacy,jQuery),function(t,e){"use strict";t.Grid.registerExtender(t.Grid.Extender.extend({init:function(t){this._super(t),this._registerBuilder()},_host_requestBuild:function(t){t.status=this._parseModelSet(JSON.parse(t.data))?"ok":"failed"},_makeCell:function(t,e){if(/locale_json$/.test(t))return{value:this._makeLocaleCell(e),meta:{original:e}};if(/json$/.test(t)){var i=e;try{i=JSON.parse(e)}catch(n){}return{value:"",meta:{original:i}}}return e&&e.toString?e.toString():""},_makeLocaleCell:function(t){return"FranÃ§ais: "+t.fra+" | English: "+t.eng},_parseModelSet:function(t){for(var e=[],i=0,n=t.length;i<n;++i)e.push(this._parseRecord(t[i]));return this._host.getDocument().change(e),!0},_parseRecord:function(t){var e=[];for(var i in t)if(t.hasOwnProperty(i))for(var n in t[i])t[i].hasOwnProperty(n)&&!/locale$/.test(n)&&e.push(this._makeCell(n,t[i][n]));return e},_registerBuilder:function(){this._host.registerDocumentBuilder("application/cakephp-records",this._host_requestBuild.bind(this))}}))}(HeO2_legacy,jQuery);
